# 业务流程设计

## 1. 用户管理流程

### 1.1 用户注册流程

```
用户 -> 访问注册页面 -> 填写注册信息(用户名/密码/邮箱) -> 提交注册表单
系统 -> 验证表单数据 -> 检查用户名和邮箱唯一性 -> 创建用户账号 -> 发送邮箱验证邮件
用户 -> 收到验证邮件 -> 点击验证链接
系统 -> 验证邮箱 -> 激活账号 -> 重定向到登录页
```

**说明**：
- 注册仅对代理开放，代理管理员和超级管理员账号由系统管理员手动创建
- 注册成功后，用户默认为普通代理角色
- 邮箱验证有效期为24小时，超时需重新发送验证邮件

### 1.2 用户登录流程

```
用户 -> 访问登录页面 -> 输入用户名和密码 -> 输入验证码 -> 提交登录表单
系统 -> 验证用户名和密码 -> 验证验证码 -> 检查账号状态
系统 -> 生成登录令牌 -> 记录登录日志 -> 重定向到对应角色首页
```

**说明**：
- 连续登录失败3次后，需要输入验证码
- 连续登录失败5次后，账号锁定15分钟
- 登录成功后，根据用户角色重定向到不同的首页

### 1.3 找回密码流程

```
用户 -> 访问找回密码页面 -> 输入邮箱 -> 提交表单
系统 -> 验证邮箱存在性 -> 生成重置密码链接 -> 发送重置密码邮件
用户 -> 收到重置密码邮件 -> 点击重置链接 -> 输入新密码 -> 提交
系统 -> 更新用户密码 -> 重定向到登录页
```

**说明**：
- 重置密码链接有效期为1小时
- 重置密码成功后，系统会发送密码变更通知邮件
- 新密码必须符合系统密码策略

### 1.4 代理管理流程

```
代理管理员 -> 登录系统 -> 进入代理管理页面 -> 查看代理列表
代理管理员 -> 点击添加代理 -> 填写代理信息 -> 提交
系统 -> 创建代理账号 -> 设置初始额度 -> 发送账号信息邮件
代理 -> 收到账号信息 -> 首次登录 -> 修改初始密码
```

**说明**：
- 代理管理员只能管理自己创建的代理
- 代理账号创建后，默认状态为激活
- 代理管理员可以为代理充值额度、禁用账号等操作

## 2. 项目管理流程

### 2.1 项目创建流程

```
超级管理员 -> 登录系统 -> 进入项目管理页面 -> 点击添加项目
超级管理员 -> 填写项目信息(名称/描述/版本等) -> 提交
系统 -> 生成项目API密钥和密钥 -> 创建项目记录
超级管理员 -> 查看项目详情 -> 配置项目参数
```

**说明**：
- 项目创建后，默认状态为激活
- 系统自动生成唯一的API密钥和密钥
- 项目创建后，需要授权给代理才能使用

### 2.2 项目授权流程

#### 2.2.1 管理员主动授权

```
代理管理员/超级管理员 -> 进入项目授权管理 -> 点击添加授权
管理员 -> 选择项目和代理 -> 设置有效期 -> 提交
系统 -> 创建授权记录 -> 发送授权通知
代理 -> 收到授权通知 -> 查看已授权项目
```

**说明**：
- 代理管理员只能授权自己创建的代理
- 超级管理员可以授权任何代理
- 授权可以设置有效期，到期自动失效

#### 2.2.2 代理申请授权

```
代理 -> 进入项目管理页面 -> 查看可申请项目 -> 点击申请
代理 -> 填写申请理由 -> 提交申请
系统 -> 创建申请记录 -> 通知上级管理员
管理员 -> 查看申请 -> 审核申请 -> 同意/拒绝
系统 -> 更新申请状态 -> 同意则创建授权记录 -> 通知代理
```

**说明**：
- 代理只能申请系统中已有的项目
- 申请需要上级管理员审核
- 审核通过后，自动创建授权记录

## 3. 卡密管理流程

### 3.1 卡密生成流程

```
代理 -> 登录系统 -> 进入卡密管理页面 -> 点击生成卡密
代理 -> 选择项目 -> 设置数量和有效期 -> 提交
系统 -> 检查代理额度 -> 计算所需额度 -> 扣除代理额度
系统 -> 生成卡密批次 -> 生成卡密记录 -> 返回生成结果
代理 -> 查看生成结果 -> 导出卡密
```

**说明**：
- 代理必须有足够的额度才能生成卡密
- 卡密生成后，状态为未使用
- 卡密号采用随机算法生成，确保唯一性
- 卡密生成后，可以导出为Excel或CSV格式

### 3.2 卡密验证流程

```
客户端 -> 调用验证接口 -> 提交卡密和设备信息
系统 -> 验证卡密存在性 -> 检查卡密状态 -> 检查项目状态
系统 -> 首次使用：绑定设备并激活 -> 非首次：验证设备绑定
系统 -> 更新卡密状态 -> 记录验证日志 -> 返回验证结果
客户端 -> 接收验证结果 -> 根据结果决定后续操作
```

**说明**：
- 卡密首次使用时会绑定设备，后续只能在绑定设备上使用
- 卡密激活后，开始计算有效期
- 卡密过期后，状态自动变为已过期
- 验证接口支持回调通知项目方

### 3.3 卡密解绑流程

```
代理 -> 登录系统 -> 进入卡密管理 -> 查找卡密 -> 点击解绑
系统 -> 验证卡密状态 -> 清除设备绑定 -> 更新卡密状态
系统 -> 记录操作日志 -> 返回操作结果
```

**说明**：
- 只有已使用且未过期的卡密可以解绑
- 解绑后，卡密状态变为未使用
- 解绑操作会记录在操作日志中
- 解绑不会重置卡密有效期

## 4. 额度管理流程

### 4.1 额度充值流程

#### 4.1.1 管理员充值给代理

```
管理员 -> 登录系统 -> 进入代理管理 -> 选择代理 -> 点击充值
管理员 -> 输入充值金额 -> 确认充值
系统 -> 检查管理员额度 -> 扣除管理员额度 -> 增加代理额度
系统 -> 创建额度记录 -> 通知代理 -> 返回充值结果
```

**说明**：
- 管理员必须有足够的额度才能给代理充值
- 充值金额必须为正数
- 充值成功后，系统会创建两条额度记录（管理员减少，代理增加）

#### 4.1.2 超级管理员充值

```
超级管理员 -> 登录系统 -> 进入用户管理 -> 选择用户 -> 点击充值
超级管理员 -> 输入充值金额 -> 确认充值
系统 -> 增加用户额度 -> 创建额度记录 -> 通知用户
```

**说明**：
- 超级管理员可以给任何用户充值
- 超级管理员充值不受额度限制
- 充值记录会标记为系统充值

### 4.2 额度转账流程

```
代理 -> 登录系统 -> 进入额度管理 -> 点击转账
代理 -> 输入接收方用户名 -> 输入转账金额 -> 确认转账
系统 -> 验证接收方存在性 -> 检查转账方额度 -> 冻结转账金额
系统 -> 扣除转账方额度 -> 增加接收方额度 -> 解冻额度
系统 -> 创建额度记录 -> 通知双方 -> 返回转账结果
```

**说明**：
- 转账方必须有足够的额度才能转账
- 转账过程中会先冻结额度，确保操作安全
- 转账成功后，系统会创建两条额度记录（转出方减少，接收方增加）
- 转账金额必须大于系统设定的最小转账金额

### 4.3 提现申请流程

```
代理 -> 登录系统 -> 进入额度管理 -> 点击提现
代理 -> 输入提现金额和账户信息 -> 提交申请
系统 -> 检查代理额度 -> 冻结提现金额 -> 创建提现申请
管理员 -> 查看提现申请 -> 审核申请 -> 同意/拒绝
系统 -> 更新申请状态 -> 同意则扣除冻结额度，拒绝则解冻额度
系统 -> 创建额度记录 -> 通知代理
```

**说明**：
- 代理必须有足够的额度才能申请提现
- 提现申请需要上级管理员审核
- 提现金额必须大于系统设定的最小提现金额
- 提现申请审核通过后，管理员需要线下打款

## 5. 统计分析流程

### 5.1 卡密统计流程

```
用户 -> 登录系统 -> 进入统计分析 -> 查看卡密统计
系统 -> 根据用户角色和权限 -> 查询卡密数据
系统 -> 按项目、状态、时间等维度 -> 统计卡密数量
系统 -> 生成统计图表 -> 展示统计结果
```

**说明**：
- 代理只能查看自己的卡密统计
- 代理管理员可以查看自己和下级代理的卡密统计
- 超级管理员可以查看所有卡密统计
- 统计数据支持多种图表展示（柱状图、折线图、饼图等）

### 5.2 额度统计流程

```
用户 -> 登录系统 -> 进入统计分析 -> 查看额度统计
系统 -> 根据用户角色和权限 -> 查询额度数据
系统 -> 按类型、时间等维度 -> 统计额度变动
系统 -> 生成统计图表 -> 展示统计结果
```

**说明**：
- 代理只能查看自己的额度统计
- 代理管理员可以查看自己和下级代理的额度统计
- 超级管理员可以查看所有额度统计
- 统计数据支持导出Excel或PDF格式

### 5.3 用户活跃度统计流程

```
管理员 -> 登录系统 -> 进入统计分析 -> 查看用户活跃度
系统 -> 根据管理员权限 -> 查询用户登录和操作数据
系统 -> 按时间、操作类型等维度 -> 统计用户活跃度
系统 -> 生成活跃度热力图 -> 展示统计结果
```

**说明**：
- 代理管理员可以查看下级代理的活跃度
- 超级管理员可以查看所有用户的活跃度
- 活跃度指标包括登录次数、操作次数、在线时长等
- 活跃度统计支持日、周、月、年等时间维度

## 6. 系统管理流程

### 6.1 系统配置管理流程

```
超级管理员 -> 登录系统 -> 进入系统配置 -> 查看配置列表
超级管理员 -> 修改配置项 -> 保存配置
系统 -> 验证配置有效性 -> 更新配置 -> 应用新配置
系统 -> 记录配置变更日志
```

**说明**：
- 只有超级管理员可以修改系统配置
- 部分配置修改后需要重启系统才能生效
- 配置变更会记录详细的操作日志
- 系统配置包括基本设置、安全设置、额度设置、通知设置等

### 6.2 轮播图管理流程

```
超级管理员 -> 登录系统 -> 进入轮播图管理 -> 查看轮播图列表
超级管理员 -> 点击添加轮播图 -> 上传图片 -> 设置链接和排序 -> 提交
系统 -> 验证图片格式和大小 -> 保存轮播图 -> 更新轮播图列表
```

**说明**：
- 轮播图支持JPG、PNG格式，大小不超过2MB
- 轮播图可以设置排序号，决定显示顺序
- 轮播图可以设置状态（激活/禁用）
- 轮播图可以设置链接，点击跳转到指定页面

### 6.3 日志管理流程

```
管理员 -> 登录系统 -> 进入日志管理 -> 选择日志类型
管理员 -> 设置查询条件（时间范围、级别、模块等）-> 查询
系统 -> 根据条件查询日志 -> 分页展示日志列表
管理员 -> 查看日志详情 -> 导出日志
```

**说明**：
- 日志类型包括操作日志、登录日志、系统日志
- 代理管理员只能查看自己和下级代理的日志
- 超级管理员可以查看所有日志
- 日志保留期限为3个月，超期自动归档

## 7. 通知消息流程

### 7.1 系统通知流程

```
超级管理员 -> 登录系统 -> 进入通知管理 -> 点击发送通知
超级管理员 -> 选择通知类型和接收对象 -> 编写通知内容 -> 发送
系统 -> 创建通知记录 -> 推送通知给接收对象
用户 -> 登录系统 -> 查看通知中心 -> 阅读通知
```

**说明**：
- 通知类型包括系统公告、功能更新、维护通知等
- 接收对象可以是全部用户、指定角色或指定用户
- 通知支持即时推送和定时发送
- 用户可以标记通知为已读

### 7.2 业务通知流程

```
系统 -> 监控业务事件 -> 触发通知条件 -> 生成业务通知
系统 -> 确定通知接收对象 -> 创建通知记录 -> 推送通知
用户 -> 登录系统 -> 查看通知中心 -> 阅读通知 -> 处理相关业务
```

**说明**：
- 业务通知由系统自动触发，无需人工干预
- 业务通知类型包括卡密激活、额度变动、授权到期等
- 业务通知会关联相关业务数据，方便用户快速处理
- 业务通知支持邮件和站内信两种方式

## 8. API接口调用流程

### 8.1 API认证流程

```
客户端 -> 准备请求参数 -> 计算签名 -> 发送API请求
系统 -> 验证API密钥 -> 验证签名 -> 验证请求时间戳
系统 -> 验证通过 -> 处理业务请求 -> 返回结果
客户端 -> 接收结果 -> 处理业务逻辑
```

**说明**：
- API请求需要包含API密钥、时间戳和签名
- 签名算法采用HMAC-SHA256
- 请求时间戳与服务器时间差不能超过5分钟
- API调用频率有限制，超过限制会被临时封禁

### 8.2 卡密验证API流程

```
客户端 -> 收集卡密和设备信息 -> 调用验证API
系统 -> 进行API认证 -> 验证卡密 -> 处理设备绑定
系统 -> 更新卡密状态 -> 记录验证日志 -> 返回验证结果
客户端 -> 接收验证结果 -> 根据结果决定后续操作
```

**说明**：
- 验证API是最常用的接口，用于软件激活
- 验证成功后，返回卡密剩余有效期
- 验证失败会返回详细的错误原因
- 支持设置回调URL，通知项目方验证结果

### 8.3 卡密查询API流程

```
客户端 -> 准备查询参数 -> 调用查询API
系统 -> 进行API认证 -> 查询卡密信息
系统 -> 返回卡密状态、有效期等信息
客户端 -> 接收查询结果 -> 展示卡密信息
```

**说明**：
- 查询API用于获取卡密详细信息
- 只能查询属于调用方项目的卡密
- 返回信息包括卡密状态、激活时间、过期时间等
- 查询操作会记录在API调用日志中

## 9. 异常处理流程

### 9.1 账号异常处理流程

```
系统 -> 检测到账号异常行为 -> 触发安全预警
系统 -> 根据异常类型 -> 执行相应措施（锁定账号、限制操作等）
系统 -> 通知用户和管理员 -> 记录异常日志
用户/管理员 -> 处理异常 -> 恢复账号正常状态
```

**说明**：
- 异常行为包括连续登录失败、异地登录、敏感操作频繁等
- 系统会根据异常严重程度采取不同措施
- 账号锁定后需要联系上级管理员解锁
- 异常处理过程会详细记录在安全日志中

### 9.2 交易异常处理流程

```
系统 -> 检测到交易异常 -> 触发交易预警
系统 -> 暂停相关交易 -> 通知相关用户和管理员
管理员 -> 审核异常交易 -> 决定处理方式
系统 -> 执行处理决定 -> 恢复或撤销交易 -> 记录处理结果
```

**说明**：
- 交易异常包括大额转账、短时间内频繁交易、异常提现等
- 异常交易会被自动暂停，等待管理员审核
- 管理员可以选择放行、拒绝或部分处理
- 交易异常处理会通知所有相关方

### 9.3 系统故障处理流程

```
系统 -> 监控到故障 -> 触发故障告警
系统 -> 记录故障日志 -> 通知技术人员
技术人员 -> 分析故障原因 -> 制定修复方案
技术人员 -> 实施修复 -> 验证系统恢复 -> 编写故障报告
```

**说明**：
- 系统故障包括服务不可用、数据库异常、性能下降等
- 故障告警支持多种方式（短信、邮件、电话等）
- 严重故障会启动应急预案
- 故障修复后会进行根因分析，防止再次发生

## 10. 数据备份与恢复流程

### 10.1 数据备份流程

```
系统 -> 按计划触发备份任务 -> 确定备份范围和方式
系统 -> 执行备份操作 -> 验证备份完整性
系统 -> 压缩并加密备份文件 -> 存储到备份位置
系统 -> 清理过期备份 -> 记录备份日志
```

**说明**：
- 数据备份包括全量备份和增量备份
- 全量备份每周一次，增量备份每天一次
- 备份文件使用AES-256加密
- 备份保留策略：每日备份保留7天，每周备份保留4周，每月备份保留12个月

### 10.2 数据恢复流程

```
管理员 -> 确认需要恢复数据 -> 选择恢复点
管理员 -> 提交恢复申请 -> 审批通过
系统 -> 准备恢复环境 -> 解密备份文件
系统 -> 执行恢复操作 -> 验证数据一致性
系统 -> 切换到恢复后的数据 -> 记录恢复日志
```

**说明**：
- 数据恢复需要经过严格的审批流程
- 大规模恢复会先在测试环境验证
- 恢复过程中会暂停相关业务
- 恢复完成后会进行数据一致性检查

## 11. 系统升级流程

### 11.1 版本发布流程

```
开发团队 -> 完成新版本开发 -> 提交测试
测试团队 -> 进行功能测试和回归测试 -> 确认版本质量
运维团队 -> 制定升级计划 -> 准备升级环境
运维团队 -> 发布升级公告 -> 执行系统升级
运维团队 -> 验证升级结果 -> 处理升级问题
```

**说明**：
- 版本发布遵循语义化版本规范
- 重大版本升级会提前一周发布公告
- 升级优先在非高峰时段进行
- 升级支持回滚机制，确保出现问题时可以快速恢复

### 11.2 紧急修复流程

```
发现严重bug或安全漏洞 -> 评估影响范围和严重程度
开发团队 -> 紧急开发修复补丁 -> 提交测试
测试团队 -> 进行针对性测试 -> 确认修复有效
运维团队 -> 发布紧急修复公告 -> 应用补丁
运维团队 -> 监控系统状态 -> 确认问题解决
```

**说明**：
- 紧急修复针对严重bug或安全漏洞
- 紧急修复可能在任何时间进行
- 修复前会评估对业务的影响
- 修复后会发布详细的问题报告

## 12. 对接第三方系统流程

### 12.1 支付系统对接流程

```
系统管理员 -> 选择支付渠道 -> 申请开通接口
系统管理员 -> 获取接口参数 -> 配置支付接口
开发人员 -> 实现支付接口 -> 进行测试支付
系统管理员 -> 配置生产环境 -> 上线支付功能
```

**说明**：
- 支持多种支付渠道（支付宝、微信、银联等）
- 支付接口参数存储在加密配置中
- 支付过程有完整的日志记录
- 支付结果通过异步通知和主动查询双重保障

### 12.2 短信服务对接流程

```
系统管理员 -> 选择短信服务商 -> 申请开通接口
系统管理员 -> 获取接口参数 -> 配置短信接口
开发人员 -> 实现短信发送功能 -> 测试短信发送
系统管理员 -> 配置短信模板 -> 上线短信功能
```

**说明**：
- 短信用于验证码、通知等场景
- 短信模板需要提前审核
- 短信发送有频率限制和内容审核
- 短信发送结果有完整的日志记录